# scenario_manager ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è§£èª¬

## ğŸ“‹ æ¦‚è¦

`scenario_manager` ã¯ã€ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã® **ç®¡ç†ãƒ»å¤‰æ›** ã‚’è¡Œã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ã€‚

**ä¸»ãªå½¹å‰²ï¼š**
- nuPlan ã‚·ãƒŠãƒªã‚ªã®è§£æ
- å æœ‰åº¦ã‚°ãƒªãƒƒãƒ‰ï¼ˆoccupancy gridï¼‰ã®ç”Ÿæˆ
- ãƒ«ãƒ¼ãƒˆæƒ…å ±ã®ç®¡ç†
- ã‚³ã‚¹ãƒˆåœ°å›³ã®è¨ˆç®—

---

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
scenario_manager/
â”œâ”€â”€ scenario_manager.py          # ãƒ¡ã‚¤ãƒ³: ã‚·ãƒŠãƒªã‚ªç®¡ç†
â”œâ”€â”€ occupancy_map.py             # å æœ‰åº¦ã‚°ãƒªãƒƒãƒ‰
â”œâ”€â”€ cost_map_manager.py          # ã‚³ã‚¹ãƒˆåœ°å›³
â”œâ”€â”€ route_manager.py             # ãƒ«ãƒ¼ãƒˆç®¡ç†
â””â”€â”€ utils/
    â”œâ”€â”€ bfs_roadblock.py         # å¹…å„ªå…ˆæ¢ç´¢
    â”œâ”€â”€ dijkstra.py              # ãƒ€ã‚¤ã‚¯ã‚¹ãƒˆãƒ©æ³•
    â””â”€â”€ route_utils.py           # ãƒ«ãƒ¼ãƒˆè£œåŠ©é–¢æ•°
```

---

## ğŸ”‘ ä¸»è¦ã‚¯ãƒ©ã‚¹

### 1. `ScenarioManager`

#### å½¹å‰²
```
ã‚·ãƒŠãƒªã‚ªå…¨ä½“ã‚’ç®¡ç†:
  - Ego çŠ¶æ…‹
  - å‘¨è¾ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  - åœ°å›³æƒ…å ±
  - ãƒ«ãƒ¼ãƒˆ
  â†’ çµ±åˆçš„ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
```

#### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------|------|
| `get_agents()` | å‘¨è¾ºã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå–å¾— |
| `get_obstacles()` | éšœå®³ç‰©å–å¾— |
| `get_route()` | ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å–å¾— |
| `update()` | çŠ¶æ…‹æ›´æ–° |

### 2. `OccupancyMap`

#### æ¦‚å¿µ
```
ã€ç©ºé–“ã‚’æ ¼å­çŠ¶ã«åˆ†å‰²ã€‘

  Ego      
   â—â”€â”€â”€â”€â”€â”€â”€â†’ å‰æ–¹
   â”‚ æ ¼å­1 â”‚ æ ¼å­2 â”‚ æ ¼å­3 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ æ ¼å­4 â”‚ æ ¼å­5 â”‚ æ ¼å­6 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å„æ ¼å­ã®å æœ‰åº¦:
  0 = ç©ºã
  1 = å æœ‰ï¼ˆéšœå®³ç‰©ã‚ã‚Šï¼‰
  -1 = ä¸æ˜
```

#### ç”¨é€”
```
è»Œè·¡ãŒéšœå®³ç‰©ã«å½“ãŸã‚‹ã‹ã‚’é«˜é€Ÿåˆ¤å®š:
  trajectory âˆˆ occupancy_map
  â†’ è¡çªåˆ¤å®š
```

### 3. `CostMapManager`

#### å½¹å‰²
```
éšœå®³ç‰©ã¾ã§ã®è·é›¢ã‚’è¨ˆç®—:
  - å„ãƒ”ã‚¯ã‚»ãƒ«ã‹ã‚‰æœ€å¯„ã‚Šéšœå®³ç‰©ã¾ã§ã®è·é›¢
  - ESDF (Euclidean Signed Distance Field)
  â†’ è»Œè·¡ã®å®‰å…¨æ€§ã‚’å®šé‡åŒ–
```

#### ã‚³ã‚¹ãƒˆåœ°å›³ã®ä¾‹

```
[-1][-2][-3][-2][-1]
[-2] 0  -1  0 [-2]
[-3]-1  [E] -1[-3]
[-2] 0  -1  0 [-2]
[-1][-2][-3][-2][-1]

[E] = Ego ä½ç½®
 0 = éšœå®³ç‰©
-1, -2, ... = è·é›¢ï¼ˆè² ã¯éšœå®³ç‰©ã‹ã‚‰é ã„ï¼‰
```

### 4. `RouteManager`

#### å½¹å‰²
```
ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³çµŒè·¯ç®¡ç†:
  - ç›®çš„åœ°
  - æ¨å¥¨çµŒè·¯
  - ç¾åœ¨åœ°
  â†’ çµŒè·¯è¿½å¾“åˆ¶å¾¡
```

---

## ğŸ“Š å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
ã€å…¥åŠ›ã€‘nuPlan ã‚·ãƒŠãƒªã‚ª
        â†“
ã€Step 1ã€‘ã‚·ãƒŠãƒªã‚ªè§£æ
  ScenarioManager ãŒå…¨ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
        â†“
ã€Step 2ã€‘å æœ‰åº¦ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
  OccupancyMap ã§ 2D æ ¼å­ã‚’ä½œæˆ
        â†“
ã€Step 3ã€‘ã‚³ã‚¹ãƒˆåœ°å›³è¨ˆç®—
  CostMapManager ã§è·é›¢ã‚’è¨ˆç®—
        â†“
ã€Step 4ã€‘ãƒ«ãƒ¼ãƒˆå–å¾—
  RouteManager ã§çµŒè·¯ã‚’æä¾›
        â†“
ã€å‡ºåŠ›ã€‘çµ±åˆã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿
  ãƒ¢ãƒ‡ãƒ«ã§ç›´æ¥ä½¿ç”¨å¯èƒ½
```

---

## ğŸ’¡ å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ

### 1. åŠ¹ç‡çš„ãªã‚°ãƒªãƒƒãƒ‰è¡¨ç¾

```python
# ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚’é‡è¦–
occupancy_grid = torch.zeros((H, W))
# ã‚¹ãƒ‘ãƒ¼ã‚¹è¡¨ç¾ï¼ˆåœ§ç¸®ï¼‰

# vs å…¨åº§æ¨™ã§ã®è¡¨ç¾ï¼ˆéåŠ¹ç‡ï¼‰
obstacles = [(x1, y1), (x2, y2), ...]  # ãƒ¡ãƒ¢ãƒªå¤šç”¨
```

### 2. ESDF è¨ˆç®—

```
ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :
  1. åˆæœŸ: éšœå®³ç‰©ã®è·é›¢ = 0
  2. åå¾©: å„ãƒ”ã‚¯ã‚»ãƒ«ã®æœ€å°è·é›¢ã‚’æ›´æ–°
  3. åæŸ: ã™ã¹ã¦ã®ãƒ”ã‚¯ã‚»ãƒ«ã§ç¢ºå®š
  
æ™‚é–“è¨ˆç®—é‡: O(H*W*log(H+W))
```

### 3. ãƒ«ãƒ¼ãƒˆå–å¾—

```
æ–¹æ³•:
  - Dijkstra: æœ€çŸ­çµŒè·¯ï¼ˆè·é›¢æœ€å°ï¼‰
  - BFS: æœ€å¿«é€ŸçµŒè·¯ï¼ˆã‚¹ãƒ†ãƒƒãƒ—æœ€å°ï¼‰
```

---

## ğŸš€ ä½¿ç”¨ä¾‹

### ã‚·ãƒŠãƒªã‚ªã®å–å¾—

```python
from src.scenario_manager.scenario_manager import ScenarioManager

manager = ScenarioManager(scenario)

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±
agents = manager.get_agents()
print(f"å‘¨è¾ºã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ•°: {len(agents)}")

# ãƒ«ãƒ¼ãƒˆæƒ…å ±
route = manager.get_route()
print(f"ç›®çš„åœ°: {route.destination}")
```

### å æœ‰åº¦ã‚°ãƒªãƒƒãƒ‰

```python
from src.scenario_manager.occupancy_map import OccupancyMap

occ_map = OccupancyMap(
    grid_size=(100, 100),  # 100m x 100m
    resolution=0.2         # 0.2m/pixel
)

occ_map.add_obstacles(agents)
occ_map.add_obstacles(static_objects)

# è»Œè·¡ã®è¡çªåˆ¤å®š
collision = occ_map.check_trajectory(trajectory)
```

### ã‚³ã‚¹ãƒˆåœ°å›³

```python
from src.scenario_manager.cost_map_manager import CostMapManager

cost_mgr = CostMapManager()

cost_map = cost_mgr.compute(
    occupancy_grid=occ_map.grid,
    resolution=0.2
)

# è»Œè·¡ã®å®‰å…¨æ€§ã‚¹ã‚³ã‚¢
safety_score = cost_map.evaluate_trajectory(trajectory)
```

---

## ğŸ“Š ã‚°ãƒªãƒƒãƒ‰è§£åƒåº¦ã®é¸æŠ

| è§£åƒåº¦ | ç²¾åº¦ | è¨ˆç®—é€Ÿåº¦ | æ¨å¥¨ç”¨é€” |
|-------|------|--------|---------|
| 0.1m | é«˜ | ä½ | è¯¦ç»†è©•ä¾¡ |
| 0.2m | ä¸­ | ä¸­ | ãƒãƒ©ãƒ³ã‚¹ |
| 0.5m | ä½ | é«˜ | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  |

---

## ğŸ“š é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- [feature_builders/README.md](../feature_builders/README.md) - ç‰¹å¾´é‡è¨ˆç®—
- [post_processing/README.md](../post_processing/README.md) - è»Œè·¡è©•ä¾¡
