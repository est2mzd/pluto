# feature_builders ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è§£èª¬

## ğŸ“‹ æ¦‚è¦

`feature_builders` ã¯ã€nuPlan ã‚·ãƒŠãƒªã‚ªã‹ã‚‰ **PLUTOãƒ¢ãƒ‡ãƒ«ãŒå¿…è¦ã¨ã™ã‚‹ç‰¹å¾´é‡ï¼ˆfeaturesï¼‰ã‚’è¨ˆç®—ãƒ»æŠ½å‡º** ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ã€‚

**ä¸»ãªå½¹å‰²ï¼š**
- ç”Ÿã®ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ï¼ˆego, ä»–è»Š, åœ°å›³ï¼‰ã‹ã‚‰æ§‹é€ åŒ–ã•ã‚ŒãŸç‰¹å¾´é‡ã‚’ç”Ÿæˆ
- éå»/å°†æ¥ã®è»Œè·¡æƒ…å ±ã€ç›¸äº’ä½œç”¨æƒ…å ±ã€ãƒãƒƒãƒ—æƒ…å ±ã‚’çµ±åˆ
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯èƒ½ãªå½¢å¼ã§ç‰¹å¾´é‡ã‚’å‡ºåŠ›

### ğŸ¯ ãªãœç‰¹å¾´é‡ãƒ“ãƒ«ãƒ€ãƒ¼ãŒå¿…è¦ï¼Ÿ

```
ã€å…¥åŠ›ã€‘ç”Ÿã®ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿
  - Ego ä½ç½®: (x, y, heading, velocity)
  - ä»–è»Š: è¤‡æ•°ã® (position, heading, velocity)
  - åœ°å›³: ãƒãƒªã‚´ãƒ³ã€äº¤é€šä¿¡å·ãªã©
  - æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿
        â†“
   âŒ ã“ã®ã¾ã¾ã ã¨ãƒ¢ãƒ‡ãƒ«ãŒå‡¦ç†å›°é›£
   ï¼ˆæ¬¡å…ƒãŒé«˜ã„ã€å½¢å¼ãŒã¾ã¡ã¾ã¡ï¼‰
        â†“
ã€å‡¦ç†ã€‘PlutoFeatureBuilder
  - 21ã‚¹ãƒ†ãƒƒãƒ—ã®éå»è»Œè·¡ã‚’é›†ç´„
  - 8ç§’å…ˆã®å°†æ¥è»Œè·¡ã‚’é›†ç´„
  - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®ç›¸äº’ä½œç”¨ã‚’è¨ˆç®—
  - ãƒãƒƒãƒ—æƒ…å ±ã‚’æ§‹é€ åŒ–
        â†“
ã€å‡ºåŠ›ã€‘PlutoFeature
  - agent: (æœ€å¤§64å€‹, æ™‚é–“ã‚¹ãƒ†ãƒƒãƒ—, ç‰¹å¾´é‡)
  - map: (äº¤é€šä¿¡å·, ãƒãƒªã‚´ãƒ³ãªã©)
  - current_state: Ego ã®ç¾åœ¨çŠ¶æ…‹
  - ä»–...
        â†“
âœ… ãƒ¢ãƒ‡ãƒ«ãŒå‡¦ç†å¯èƒ½ãªå½¢å¼
```

---

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `pluto_feature_builder.py` | ãƒ¡ã‚¤ãƒ³ï¼šç‰¹å¾´é‡è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ |
| `common.py` | è£œåŠ©é–¢æ•°ï¼ˆæ­£è¦åŒ–ã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼‰ |
| `nuplan_scenario_render.py` | ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç‰¹å¾´é‡ã®å¯è¦–åŒ– |

---

## ğŸ”‘ ä¸»è¦ã‚¯ãƒ©ã‚¹

### `PlutoFeatureBuilder` ã‚¯ãƒ©ã‚¹

#### å½¹å‰²
nuplan-devkit ã® `AbstractFeatureBuilder` ã‚’æ‹¡å¼µã—ã€PLUTOãƒ¢ãƒ‡ãƒ«ç”¨ã®ç‰¹å¾´é‡ã‚’è¨ˆç®—ã€‚

#### ä¸»è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|-----------|----------|------|
| `radius` | `100` | Ego å‘¨è¾ºã§è€ƒæ…®ã™ã‚‹ã‚¨ãƒªã‚¢ (m) |
| `history_horizon` | `2` | éå»ä½•ç§’é–“ã®è»Œè·¡ã‚’ä¿æŒ |
| `future_horizon` | `8` | å°†æ¥ä½•ç§’é–“ã®è»Œè·¡ã‚’è¨ˆç®— |
| `sample_interval` | `0.1` | ã‚µãƒ³ãƒ—ãƒ«é–“éš” (ç§’) |
| `max_agents` | `64` | æœ€å¤§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ•° |
| `max_static_obstacles` | `10` | æœ€å¤§é™æ­¢éšœå®³ç‰©æ•° |
| `build_reference_line` | `false` | ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ãƒ©ã‚¤ãƒ³ã‚’è¨ˆç®—ã™ã‚‹ã‹ |
| `disable_agent` | `false` | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±ã‚’é™¤å¤–ã™ã‚‹ã‹ |

#### è¨ˆç®—ã•ã‚Œã‚‹ç‰¹å¾´é‡

```python
feature.data = {
    # Ego çŠ¶æ…‹
    "current_state": [x, y, yaw, vel, acc, steer, steer_rate, ...],
    "origin": [origin_x, origin_y],  # åº§æ¨™åŸç‚¹
    "angle": yaw_angle,              # Ego ã®å‘ã
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±
    "agent": {
        "position": (max_agents, time_steps, 2),   # (x, y)
        "heading": (max_agents, time_steps),       # yaw
        "velocity": (max_agents, time_steps, 2),   # (vx, vy)
        "shape": (max_agents, 2),                  # (width, length)
        "category": (max_agents,),                 # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç¨®é¡
        "valid_mask": (max_agents,),               # æœ‰åŠ¹ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        "target": (max_agents, future_steps, 3)    # (Î”x, Î”y, Î”yaw)
    },
    
    # ãƒãƒƒãƒ—æƒ…å ±
    "map": {
        "polygon_tl_status": (num_tl,),     # äº¤é€šä¿¡å·çŠ¶æ…‹
        "polygon_tl_id": (num_tl,),         # äº¤é€šä¿¡å·ID
        ...ãã®ä»–ãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    },
    
    # ã‚³ã‚¹ãƒˆåœ°å›³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    "cost_maps": (H, W),  # occupancy grid
    
    # å› æœé–¢ä¿‚æƒ…å ±
    "causal": {
        "interaction_label": (max_agents,),
        "leading_agent_mask": (max_agents,),
        ...
    }
}
```

---

## ğŸ”„ å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
ã€å…¥åŠ›ã€‘AbstractScenario
  â†“
ã€Step 1ã€‘Ego çŠ¶æ…‹ã®æŠ½å‡º
  - ç¾åœ¨ä½ç½®ã€é€Ÿåº¦ã€å‘ã
  â†“
ã€Step 2ã€‘ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±ã®é›†ç´„
  - éå»21ã‚¹ãƒ†ãƒƒãƒ—ã®è»Œè·¡
  - å°†æ¥è»Œè·¡ã®è¨ˆç®—
  - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç¨®é¡ã®åˆ†é¡
  â†“
ã€Step 3ã€‘ãƒãƒƒãƒ—æƒ…å ±ã®æŠ½å‡º
  - äº¤é€šä¿¡å·ã®ä½ç½®ãƒ»çŠ¶æ…‹
  - ãƒãƒªã‚´ãƒ³ï¼ˆè»Šç·šã€äº¤å·®ç‚¹ãªã©ï¼‰
  â†“
ã€Step 4ã€‘æ­£è¦åŒ–ãƒ»ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
  - å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æœ€å¤§64å€‹ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
  - å€¤ã‚’ 0ï½1 ã«æ­£è¦åŒ–
  â†“
ã€å‡ºåŠ›ã€‘PlutoFeature
```

---

## ğŸ’¡ å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ

### 1. éå»è»Œè·¡ã®é›†ç´„
```
history_horizon = 2ç§’ (21 ã‚¹ãƒ†ãƒƒãƒ—)
current_time = 10.0ç§’

éå»è»Œè·¡:
  t = 8.0ç§’  â†’ position[0]
  t = 8.1ç§’  â†’ position[1]
  ...
  t = 9.9ç§’  â†’ position[20]
  t = 10.0ç§’ â†’ current_state (ç‰¹åˆ¥æ‰±ã„)
```

### 2. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé¸åˆ¥
- Ego ã‹ã‚‰ `radius` ä»¥å†…ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿ã‚’ä¿æŒ
- ç¯„å›²å¤–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ç„¡è¦–

### 3. æ­£è¦åŒ–
```python
# å€¤ã®ç¯„å›²ã‚’ 0ï½1 ã«æ­£è¦åŒ–
(value - min_value) / (max_value - min_value)

ã“ã‚Œã«ã‚ˆã‚Šã€ç•°ãªã‚‹ã‚¹ã‚±ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ãŒçµ±ä¸€ã•ã‚Œã‚‹
```

---

## ğŸš€ ä½¿ç”¨ä¾‹

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

```yaml
# config/model/pluto_model.yaml
feature_builders:
  - _target_: src.feature_builders.PlutoFeatureBuilder
    radius: 100
    history_horizon: 2.0
    future_horizon: 8.0
    sample_interval: 0.1
    max_agents: 64
    max_static_obstacles: 10
```

### ã‚³ãƒ¼ãƒ‰ä¾‹

```python
from src.feature_builders.pluto_feature_builder import PlutoFeatureBuilder

# ãƒ“ãƒ«ãƒ€ãƒ¼ã®ä½œæˆ
builder = PlutoFeatureBuilder(
    radius=100,
    history_horizon=2.0,
    future_horizon=8.0
)

# ç‰¹å¾´é‡è¨ˆç®—
feature = builder(scenario, planner_input)

# ç‰¹å¾´é‡ã®ç¢ºèª
print(feature.data.keys())
# dict_keys(['agent', 'map', 'current_state', ...])
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®è©³ç´°

### Agent æƒ…å ±
```python
feature.data["agent"]["position"].shape = (max_agents, time_steps, 2)
# ä¾‹: (64, 21, 2)
# â†’ æœ€å¤§64ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€21ã‚¹ãƒ†ãƒƒãƒ—ã®éå»è»Œè·¡ã€å„ã‚¹ãƒ†ãƒƒãƒ—(x, y)åº§æ¨™
```

### Map æƒ…å ±
```python
feature.data["map"]["polygon_tl_status"]  # äº¤é€šä¿¡å·
feature.data["map"]["polygon_road_edge"]   # é“è·¯ã®ç«¯
feature.data["map"]["polygon_lane"]        # è»Šç·š
...å„ç¨®ãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
```

### Cost Maps
```python
feature.data["cost_maps"].shape = (H, W)
# ä¾‹: (500, 500)
# å„ãƒ”ã‚¯ã‚»ãƒ«ãŒå æœ‰åº¦ã‚’è¡¨ã™ï¼ˆ0=free, -200=occupiedï¼‰
```

---

## ğŸ› ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼

### Error: `radius` ãŒå°ã•ã™ãã‚‹
```
åŸå› : Ego ã®å‘¨è¾ºã§é‡è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒé™¤å¤–ã•ã‚Œã‚‹
è§£æ±º: radius ã‚’å¢—ã‚„ã™ï¼ˆ100ï½150ï¼‰
```

### Warning: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ•°ãŒ max_agents ã‚’è¶…ãˆã‚‹
```
åŸå› : å¯†é›†ã—ãŸã‚·ãƒŠãƒªã‚ªã§å¤šãã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå­˜åœ¨
è§£æ±º: max_agents ã‚’å¢—ã‚„ã™ï¼ˆ64 â†’ 128ï¼‰
```

---

## ğŸ“š é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- [features/pluto_feature.py](../features/README.md) - å‡ºåŠ›å½¢å¼
- [custom_training/README.md](../custom_training/README.md) - è¨“ç·´ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
